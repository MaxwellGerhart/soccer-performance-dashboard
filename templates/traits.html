{% extends "layout.html" %}

{% block content %}
<div class="mb-3">
  <a href="{{ url_for('home') }}" class="btn btn-primary">
    <i class="fas fa-home"></i> Home
  </a>
</div>

<div class="row mb-4">
  <div class="col-md-12">
    <h2>Advanced Player Traits</h2>
    <p class="text-muted">
      Advanced performance metrics calculated from StatsBomb World Cup 2022 data using spatial awareness, 
      decision efficiency, and technical execution analysis.
    </p>
  </div>
</div>

<!-- Trait Explanations -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="fas fa-brain"></i> Spatial Awareness Score (SAS)</h6>
      </div>
      <div class="card-body">
        <small>
          Measures a player's ability to find space and position themselves effectively. 
          Combines distance to opponents, between-the-lines positioning, and forward orientation.
        </small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-header bg-warning text-white">
        <h6 class="mb-0"><i class="fas fa-clock"></i> Decision Efficiency Index (DEI)</h6>
      </div>
      <div class="card-body">
        <small>
          Evaluates decision-making speed and accuracy under pressure. 
          Considers time-to-pass, pressured pass completion, and turnovers.
        </small>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h6 class="mb-0"><i class="fas fa-cog"></i> Technical Execution Quotient (TEQ)</h6>
      </div>
      <div class="card-body">
        <small>
          Measures technical skill and execution quality. 
          Includes pass completion, progressive passes, final third entries, and touch accuracy.
        </small>
      </div>
    </div>
  </div>
</div>

<!-- Traits Table -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Player Trait Rankings</h5>
  </div>
  <div class="card-body">
    <table class="table table-striped" id="traitsTable">
      <thead>
        <tr>
          <th onclick="sortTable(0, 'string')" style="cursor: pointer;">Player <i class="fas fa-sort"></i></th>
          <th onclick="sortTable(1, 'number')" style="cursor: pointer;">SAS <i class="fas fa-sort"></i></th>
          <th onclick="sortTable(2, 'number')" style="cursor: pointer;">DEI <i class="fas fa-sort"></i></th>
          <th onclick="sortTable(3, 'number')" style="cursor: pointer;">TEQ <i class="fas fa-sort"></i></th>
          <th onclick="sortTable(4, 'number')" style="cursor: pointer;">Composite Score <i class="fas fa-sort"></i></th>
          <th onclick="sortTable(5, 'number')" style="cursor: pointer;">Total Events <i class="fas fa-sort"></i></th>
        </tr>
      </thead>
      <tbody>
        {% for trait in traits %}
        <tr>
          <td>
            <a href="{{ url_for('player_profile', player_name=trait.player_name) }}" 
               class="text-decoration-none">
              <i class="fas fa-user"></i> {{ trait.player_name }}
            </a>
          </td>
          <td>
            <span class="badge bg-info rounded-pill">{{ "%.1f"|format(trait.spatial_awareness_score) }}</span>
          </td>
          <td>
            <span class="badge bg-warning rounded-pill">{{ "%.1f"|format(trait.decision_efficiency_index) }}</span>
          </td>
          <td>
            <span class="badge bg-success rounded-pill">{{ "%.1f"|format(trait.technical_execution_quotient) }}</span>
          </td>
          <td>
            <span class="badge bg-primary rounded-pill">{{ "%.1f"|format(trait.composite_score) }}</span>
          </td>
          <td>{{ trait.total_events }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
let sortDirection = {};

function sortTable(columnIndex, dataType) {
  const table = document.getElementById('traitsTable');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  
  // Toggle sort direction
  sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
  
  rows.sort((a, b) => {
    let aValue, bValue;
    
    if (columnIndex === 0) {
      // Player name
      aValue = a.cells[columnIndex].textContent.trim();
      bValue = b.cells[columnIndex].textContent.trim();
    } else if (columnIndex === 5) {
      // Total events
      aValue = parseInt(a.cells[columnIndex].textContent.trim());
      bValue = parseInt(b.cells[columnIndex].textContent.trim());
    } else {
      // Score columns - extract from badge
      aValue = parseFloat(a.cells[columnIndex].querySelector('.badge').textContent);
      bValue = parseFloat(b.cells[columnIndex].querySelector('.badge').textContent);
    }
    
    let comparison = 0;
    if (dataType === 'number') {
      comparison = aValue - bValue;
    } else {
      comparison = aValue.localeCompare(bValue);
    }
    
    return sortDirection[columnIndex] === 'asc' ? comparison : -comparison;
  });
  
  // Clear tbody and append sorted rows
  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(row));
  
  // Update sort icons
  updateSortIcons(columnIndex);
}

function updateSortIcons(activeColumn) {
  const headers = document.querySelectorAll('#traitsTable th');
  headers.forEach((header, index) => {
    const icon = header.querySelector('i');
    if (index === activeColumn) {
      icon.className = sortDirection[activeColumn] === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    } else {
      icon.className = 'fas fa-sort';
    }
  });
}
</script>

<style>
/* Enhanced badge styling */
.badge.rounded-pill {
  font-size: 0.9em;
  padding: 0.5em 1em;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

/* Hover effects for table rows */
#traitsTable tbody tr:hover {
  background-color: #f8f9fa;
  transition: background-color 0.2s ease;
}
</style>
{% endblock %}
